<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood Hapi — Egyptian Flood Intelligence</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0e1a;
            --surface: #111827;
            --surface-2: #1a2236;
            --surface-3: #1f2a40;
            --border: #2a3654;
            --text: #eef0f6;
            --text-muted: #8892a8;
            --orange: #f97316;
            --orange-light: #fb923c;
            --orange-dark: #ea580c;
            --orange-glow: rgba(249, 115, 22, 0.15);
            --blue: #3b82f6;
            --blue-light: #60a5fa;
            --blue-dark: #1d4ed8;
            --blue-deep: #1e3a5f;
            --gold: #fbbf24;
            --gold-dark: #d97706;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --risk-high: #dc2626;
            --risk-medium: #f97316;
            --risk-low: #3b82f6;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1a1a2e 50%, #16213e 100%);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            height: 68px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--orange), var(--blue), var(--orange));
            background-size: 200% 100%;
            animation: gradientShift 4s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .logo-mark {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--orange), var(--orange-dark));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.3);
            position: relative;
        }
        .logo-mark svg {
            width: 26px; height: 26px;
            fill: white;
        }

        .header-brand h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--orange-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-brand .tagline {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            letter-spacing: 0.3px;
        }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-badge {
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            letter-spacing: 0.3px;
        }
        .live-dot {
            width: 8px; height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease infinite;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }

        /* ===== WAVE ANIMATION BAR ===== */
        .wave-bar {
            height: 4px;
            background: var(--surface);
            position: relative;
            overflow: hidden;
        }
        .wave-bar::before, .wave-bar::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 300%; height: 100%;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--blue) 25%,
                var(--orange) 50%,
                var(--blue) 75%,
                transparent 100%
            );
            animation: waveSlide 6s linear infinite;
            opacity: 0.6;
        }
        .wave-bar::after { animation-delay: -3s; opacity: 0.3; }
        @keyframes waveSlide {
            0% { transform: translateX(0); }
            100% { transform: translateX(33.33%); }
        }

        /* ===== MAIN LAYOUT ===== */
        .main {
            display: grid;
            grid-template-columns: 420px 1fr;
            min-height: calc(100vh - 72px);
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .input-section {
            margin-bottom: 24px;
        }
        .section-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .section-label svg {
            width: 14px; height: 14px;
            stroke: var(--orange);
            fill: none;
            stroke-width: 2;
        }

        .postcode-input-group {
            display: flex;
            gap: 8px;
        }
        .postcode-input {
            flex: 1;
            background: var(--surface-2);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 14px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 2px;
            text-transform: uppercase;
            outline: none;
            transition: all 0.3s;
        }
        .postcode-input:focus {
            border-color: var(--orange);
            box-shadow: 0 0 0 4px var(--orange-glow);
        }
        .postcode-input::placeholder {
            color: var(--text-muted);
            opacity: 0.4;
            text-transform: none;
            letter-spacing: normal;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 400;
        }

        .btn-process {
            background: linear-gradient(135deg, var(--orange), var(--orange-dark));
            border: none;
            border-radius: var(--radius);
            padding: 14px 22px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
            letter-spacing: 0.3px;
        }
        .btn-process:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
        }
        .btn-process:active { transform: scale(0.97); }
        .btn-process:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Radius selector */
        .radius-selector {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }
        .radius-btn {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
        }
        .radius-btn.active {
            background: linear-gradient(135deg, var(--blue-dark), var(--blue));
            border-color: var(--blue);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .radius-btn:hover:not(.active) {
            border-color: var(--blue-light);
            color: var(--text);
        }

        /* ===== STATS CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .stat-card:hover {
            border-color: var(--orange);
            transform: translateY(-2px);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
        }
        .stat-card.orange::before { background: var(--orange); }
        .stat-card.blue::before { background: var(--blue); }
        .stat-card.gold::before { background: var(--gold); }
        .stat-card.green::before { background: var(--success); }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1;
            margin-bottom: 4px;
        }
        .stat-card.orange .stat-value { color: var(--orange); }
        .stat-card.blue .stat-value { color: var(--blue-light); }
        .stat-card.gold .stat-value { color: var(--gold); }
        .stat-card.green .stat-value { color: var(--success); }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== RISK GAUGE ===== */
        .risk-gauge-container {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .risk-gauge-container.visible { display: block; }

        .risk-gauge-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 14px;
        }
        .gauge-svg {
            width: 200px;
            height: 110px;
            margin: 0 auto;
        }
        .gauge-bg {
            fill: none;
            stroke: var(--surface-3);
            stroke-width: 12;
            stroke-linecap: round;
        }
        .gauge-fill {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.5s ease, stroke 0.5s;
        }
        .gauge-text {
            font-family: 'Outfit', sans-serif;
            font-size: 20px;
            font-weight: 700;
            fill: var(--text);
        }
        .gauge-subtext {
            font-family: 'Outfit', sans-serif;
            font-size: 10px;
            fill: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== STATUS / PROGRESS ===== */
        .status-area {
            margin-bottom: 20px;
        }
        .status-bar {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            display: none;
        }
        .status-bar.visible { display: block; }

        .status-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
        }
        .status-spinner {
            width: 18px; height: 18px;
            border: 2.5px solid var(--border);
            border-top-color: var(--orange);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-text {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }
        .status-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .status-step {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .status-step .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--border);
            flex-shrink: 0;
            transition: all 0.3s;
        }
        .status-step.active {
            background: rgba(249, 115, 22, 0.08);
            color: var(--orange-light);
        }
        .status-step.active .dot {
            background: var(--orange);
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.5);
        }
        .status-step.done { color: var(--text); }
        .status-step.done .dot {
            background: var(--success);
            box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
        }
        .status-step.error .dot {
            background: var(--danger);
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
        }

        /* ===== RESULTS PANEL ===== */
        .results-panel {
            display: none;
        }
        .results-panel.visible { display: block; }

        .result-header {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.08), rgba(59, 130, 246, 0.08));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        .result-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--orange), var(--blue));
        }
        .result-postcode {
            font-family: 'JetBrains Mono', monospace;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--orange-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
        }
        .result-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
        }
        .result-meta span { display: flex; align-items: center; gap: 4px; }

        /* Layer results */
        .layers-section {
            margin-bottom: 16px;
        }
        .layers-section h3 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .layers-section h3 svg {
            width: 14px; height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--surface-2);
            border: 1px solid transparent;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            transition: all 0.2s;
        }
        .layer-item:hover {
            border-color: var(--border);
            transform: translateX(4px);
        }
        .layer-swatch {
            width: 16px; height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .layer-name { flex: 1; font-weight: 500; }
        .layer-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg);
            padding: 3px 10px;
            border-radius: 6px;
        }
        .layer-status {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 6px;
            font-weight: 600;
        }
        .layer-status.ok { background: rgba(34,197,94,0.12); color: var(--success); }
        .layer-status.no-data { background: rgba(139,143,168,0.12); color: var(--text-muted); }
        .layer-status.error { background: rgba(239,68,68,0.12); color: var(--danger); }

        /* Download button */
        .btn-download {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            background: linear-gradient(135deg, var(--blue), var(--blue-dark));
            border: none;
            border-radius: var(--radius);
            padding: 16px;
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            letter-spacing: 0.3px;
        }
        .btn-download:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(59, 130, 246, 0.4);
        }
        .btn-download:active { transform: scale(0.98); }

        /* ===== HISTORY ===== */
        .history-section {
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }
        .history-section h3 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--surface-2);
            border: 1px solid transparent;
            border-radius: 8px;
            margin-bottom: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-item:hover {
            background: var(--surface-3);
            border-color: var(--border);
        }
        .history-postcode {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--orange-light);
        }
        .history-features {
            color: var(--text-muted);
        }
        .history-time {
            margin-left: auto;
            color: var(--text-muted);
            font-size: 11px;
        }

        /* ===== MAP AREA ===== */
        .map-area {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--bg);
        }

        /* Flood info banner (top of map area) */
        .flood-info-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .info-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 18px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .info-card:hover {
            transform: translateY(-2px);
            border-color: var(--orange);
        }
        .info-card-icon {
            width: 36px; height: 36px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .info-card-icon.water { background: rgba(59, 130, 246, 0.15); }
        .info-card-icon.alert { background: rgba(249, 115, 22, 0.15); }
        .info-card-icon.shield { background: rgba(34, 197, 94, 0.15); }

        .info-card h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text);
        }
        .info-card p {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .info-card .info-value {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .info-card .info-value.blue { color: var(--blue-light); }
        .info-card .info-value.orange { color: var(--orange); }
        .info-card .info-value.green { color: var(--success); }

        /* Map container */
        .map-container {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
        }

        .map-placeholder {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }
        .map-placeholder .placeholder-icon {
            width: 120px; height: 120px;
            margin: 0 auto 24px;
            position: relative;
        }
        .placeholder-icon .water-drop {
            width: 60px; height: 60px;
            margin: 0 auto;
            opacity: 0.15;
        }
        .placeholder-icon .water-drop svg {
            width: 100%; height: 100%;
            fill: var(--orange);
        }
        .placeholder-icon .ripple {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px; height: 20px;
            border: 2px solid var(--blue);
            border-radius: 50%;
            opacity: 0;
            animation: ripple 3s ease-out infinite;
        }
        .placeholder-icon .ripple:nth-child(2) { animation-delay: 1s; }
        .placeholder-icon .ripple:nth-child(3) { animation-delay: 2s; }
        @keyframes ripple {
            0% { width: 30px; height: 10px; opacity: 0.4; }
            100% { width: 120px; height: 30px; opacity: 0; }
        }

        .map-placeholder h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--orange-light), var(--blue-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .map-placeholder p {
            font-size: 13px;
            color: var(--text-muted);
            max-width: 320px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .map-overlay-info {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(10, 14, 26, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 12px;
            color: var(--text-muted);
            display: none;
        }
        .map-overlay-info.visible { display: block; }
        .map-overlay-info strong {
            color: var(--orange-light);
            font-weight: 600;
        }

        /* Legend */
        .map-legend {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
        }
        .legend-group h4 {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
        }
        .legend-items { display: flex; gap: 14px; flex-wrap: wrap; }
        .legend-item {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: var(--text-muted);
        }
        .legend-color {
            width: 14px; height: 14px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* ===== ERROR TOAST ===== */
        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--danger);
            border-radius: var(--radius);
            padding: 16px 20px;
            max-width: 420px;
            font-size: 13px;
            color: var(--text);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .error-toast .error-title {
            color: var(--danger);
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== WATER WAVE FOOTER ===== */
        .wave-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--blue-dark), var(--orange), var(--blue-dark));
            background-size: 200% 100%;
            animation: gradientShift 8s ease infinite;
            pointer-events: none;
            z-index: 50;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--surface); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1000px) {
            .main { grid-template-columns: 1fr; }
            .map-area { order: -1; min-height: 300px; }
            .flood-info-bar { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-mark">
            <svg viewBox="0 0 24 24">
                <path d="M12 2C12 2 5 10 5 15C5 18.87 8.13 22 12 22C15.87 22 19 18.87 19 15C19 10 12 2 12 2Z"/>
                <path d="M10 15.5C10 16.88 10.9 18 12 18C13.1 18 14 16.88 14 15.5C14 14 12 12 12 12C12 12 10 14 10 15.5Z" fill="rgba(255,255,255,0.3)"/>
            </svg>
        </div>
        <div class="header-brand">
            <h1>Flood Hapi</h1>
            <div class="tagline">Egyptian Flood Intelligence Dashboard</div>
        </div>
        <div class="header-right">
            <div class="live-dot"></div>
            <div class="header-badge">EA NaFRA2 · EPSG:27700</div>
        </div>
    </div>
    <div class="wave-bar"></div>

    <!-- Main layout -->
    <div class="main">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Postcode input -->
            <div class="input-section">
                <div class="section-label">
                    <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    Location
                </div>
                <div class="postcode-input-group">
                    <input
                        type="text"
                        class="postcode-input"
                        id="postcodeInput"
                        placeholder="Enter UK postcode..."
                        maxlength="8"
                        autocomplete="off"
                    >
                    <button class="btn-process" id="processBtn" onclick="processPostcode()">
                        Analyse
                    </button>
                </div>

                <div class="section-label" style="margin-top: 16px;">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                    Radius
                </div>
                <div class="radius-selector">
                    <button class="radius-btn" data-radius="250" onclick="setRadius(this)">250m</button>
                    <button class="radius-btn active" data-radius="500" onclick="setRadius(this)">500m</button>
                    <button class="radius-btn" data-radius="750" onclick="setRadius(this)">750m</button>
                    <button class="radius-btn" data-radius="1000" onclick="setRadius(this)">1km</button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid" style="display:none;">
                <div class="stat-card orange">
                    <div class="stat-value" id="statFeatures">0</div>
                    <div class="stat-label">Total Cells</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-value" id="statLayers">0</div>
                    <div class="stat-label">Active Layers</div>
                </div>
                <div class="stat-card gold">
                    <div class="stat-value" id="statArea">0</div>
                    <div class="stat-label">Area (ha)</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-value" id="statRadius">500</div>
                    <div class="stat-label">Radius (m)</div>
                </div>
            </div>

            <!-- Risk Gauge -->
            <div class="risk-gauge-container" id="riskGauge">
                <div class="risk-gauge-label">Overall Flood Risk Intensity</div>
                <svg class="gauge-svg" viewBox="0 0 200 110">
                    <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100" />
                    <path class="gauge-fill" id="gaugeFill" d="M 20 100 A 80 80 0 0 1 180 100"
                          stroke="var(--blue)" stroke-dasharray="251" stroke-dashoffset="251" />
                    <text class="gauge-text" x="100" y="85" text-anchor="middle" id="gaugeValue">0%</text>
                    <text class="gauge-subtext" x="100" y="100" text-anchor="middle" id="gaugeLabel">No Data</text>
                </svg>
            </div>

            <!-- Status area -->
            <div class="status-area">
                <div class="status-bar" id="statusBar">
                    <div class="status-header">
                        <div class="status-spinner" id="statusSpinner"></div>
                        <span class="status-text" id="statusText">Analysing...</span>
                    </div>
                    <div class="status-steps" id="statusSteps">
                        <div class="status-step" id="step-geocode">
                            <span class="dot"></span>Geocoding postcode
                        </div>
                        <div class="status-step" id="step-fetch">
                            <span class="dot"></span>Downloading EA flood data (6 layers)
                        </div>
                        <div class="status-step" id="step-clip">
                            <span class="dot"></span>Clipping to radius buffer
                        </div>
                        <div class="status-step" id="step-export">
                            <span class="dot"></span>Exporting shapefiles (BNG)
                        </div>
                        <div class="status-step" id="step-zip">
                            <span class="dot"></span>Creating zip package
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results panel -->
            <div class="results-panel" id="resultsPanel">
                <div class="result-header">
                    <div class="result-postcode" id="resultPostcode"></div>
                    <div class="result-meta">
                        <span id="resultCoords"></span>
                        <span id="resultDistrict"></span>
                    </div>
                </div>

                <!-- Risk bands -->
                <div class="layers-section">
                    <h3>
                        <svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        Risk Bands
                    </h3>
                    <div id="riskLayers"></div>
                </div>

                <!-- Depth bands -->
                <div class="layers-section">
                    <h3>
                        <svg viewBox="0 0 24 24"><path d="M12 2C12 2 5 10 5 15C5 18.87 8.13 22 12 22C15.87 22 19 18.87 19 15C19 10 12 2 12 2Z"/></svg>
                        Depth Bands
                    </h3>
                    <div id="depthLayers"></div>
                </div>

                <!-- Download -->
                <button class="btn-download" id="downloadBtn" onclick="downloadResults()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download Shapefiles (.zip)
                </button>
            </div>

            <!-- History -->
            <div class="history-section" id="historySection" style="display:none;">
                <h3>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Recent Searches
                </h3>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Map area -->
        <div class="map-area">
            <!-- Flood info cards -->
            <div class="flood-info-bar">
                <div class="info-card">
                    <div class="info-card-icon water">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                            <path d="M12 2C12 2 5 10 5 15C5 18.87 8.13 22 12 22C15.87 22 19 18.87 19 15C19 10 12 2 12 2Z"/>
                        </svg>
                    </div>
                    <div class="info-value blue" id="infoHighRisk">--</div>
                    <h4>High Risk Cells</h4>
                    <p>Grid cells with >=3.3% annual flood probability</p>
                </div>
                <div class="info-card">
                    <div class="info-card-icon alert">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="info-value orange" id="infoDeepFlood">--</div>
                    <h4>Deep Flood Zones</h4>
                    <p>Areas with predicted water depth >= 0.9m</p>
                </div>
                <div class="info-card">
                    <div class="info-card-icon shield">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                    </div>
                    <div class="info-value green" id="infoDataLayers">8</div>
                    <h4>Data Layers</h4>
                    <p>NaFRA2 risk & depth bands from EA open data</p>
                </div>
            </div>

            <!-- Map -->
            <div class="map-container" id="mapContainer">
                <div class="map-placeholder" id="mapPlaceholder">
                    <div class="placeholder-icon">
                        <div class="water-drop">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 2C12 2 5 10 5 15C5 18.87 8.13 22 12 22C15.87 22 19 18.87 19 15C19 10 12 2 12 2Z"/>
                            </svg>
                        </div>
                        <div class="ripple"></div>
                        <div class="ripple"></div>
                        <div class="ripple"></div>
                    </div>
                    <h3>Awaiting the Flood</h3>
                    <p>Enter a UK postcode to analyse surface water flood risk using Environment Agency NaFRA2 data</p>
                </div>
                <img class="map-image" id="mapImage" alt="Flood risk map preview">
                <div class="map-overlay-info" id="mapOverlay">
                    <strong>WMS Preview</strong> · EA NaFRA2 RoFSW<br>
                    <span id="mapOverlayBbox"></span>
                </div>
            </div>

            <!-- Legend -->
            <div class="map-legend">
                <div class="legend-group">
                    <h4>Risk Bands</h4>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            High (>=1:30)
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f97316;"></div>
                            Medium (1:30-1:100)
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            Low (1:100-1:1000)
                        </div>
                    </div>
                </div>
                <div class="legend-group">
                    <h4>Depth Bands</h4>
                    <div class="legend-items">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #93c5fd;"></div>0.2m
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #60a5fa;"></div>0.3m
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>0.6m
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2563eb;"></div>0.9m
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #1d4ed8;"></div>1.2m
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error toast -->
    <div class="error-toast" id="errorToast">
        <div class="error-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            Error
        </div>
        <div id="errorMessage"></div>
    </div>

    <!-- Wave footer -->
    <div class="wave-footer"></div>

    <script>
        // State
        let currentRadius = 500;
        let currentResults = null;
        let history = JSON.parse(localStorage.getItem('flood-hapi-history') || '[]');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            document.getElementById('postcodeInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') processPostcode();
            });
        });

        function setRadius(btn) {
            document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentRadius = parseInt(btn.dataset.radius);
        }

        function showError(msg) {
            const toast = document.getElementById('errorToast');
            document.getElementById('errorMessage').textContent = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 6000);
        }

        function setStep(stepId, state) {
            const el = document.getElementById('step-' + stepId);
            el.className = 'status-step ' + state;
        }

        // Animate number counting up
        function animateValue(el, start, end, duration) {
            const range = end - start;
            const startTime = performance.now();
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                const current = Math.round(start + range * eased);
                el.textContent = current.toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // Update risk gauge
        function updateGauge(percent, label) {
            const fill = document.getElementById('gaugeFill');
            const text = document.getElementById('gaugeValue');
            const sub = document.getElementById('gaugeLabel');
            const gauge = document.getElementById('riskGauge');

            gauge.classList.add('visible');

            // Arc length is ~251
            const offset = 251 - (251 * (percent / 100));
            fill.style.strokeDashoffset = offset;

            // Color based on severity
            if (percent > 66) {
                fill.style.stroke = 'var(--danger)';
            } else if (percent > 33) {
                fill.style.stroke = 'var(--orange)';
            } else {
                fill.style.stroke = 'var(--blue)';
            }

            text.textContent = Math.round(percent) + '%';
            sub.textContent = label;
        }

        async function processPostcode() {
            const input = document.getElementById('postcodeInput');
            const postcode = input.value.trim();
            if (!postcode) {
                showError('Please enter a postcode');
                input.focus();
                return;
            }

            // Show status, hide results
            const statusBar = document.getElementById('statusBar');
            const resultsPanel = document.getElementById('resultsPanel');
            const processBtn = document.getElementById('processBtn');

            statusBar.classList.add('visible');
            resultsPanel.classList.remove('visible');
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('riskGauge').classList.remove('visible');
            processBtn.disabled = true;
            processBtn.textContent = 'Analysing...';

            // Reset steps
            ['geocode', 'fetch', 'clip', 'export', 'zip'].forEach(s => setStep(s, ''));

            setStep('geocode', 'active');
            document.getElementById('statusText').textContent = 'Geocoding postcode...';

            try {
                await sleep(300);
                setStep('geocode', 'done');
                setStep('fetch', 'active');
                document.getElementById('statusText').textContent = 'Downloading 6 EA layers in parallel...';

                const resp = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ postcode, radius: currentRadius }),
                });

                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'Request failed');
                }

                // Complete steps with animation
                setStep('fetch', 'done');
                await sleep(150);
                setStep('clip', 'done');
                await sleep(150);
                setStep('export', 'done');
                await sleep(150);
                setStep('zip', 'done');
                document.getElementById('statusText').textContent = 'Analysis complete!';
                document.getElementById('statusSpinner').style.display = 'none';

                currentResults = data;
                renderResults(data);
                updateStats(data);
                loadMapPreview(data);
                addToHistory(postcode, data);

            } catch (err) {
                showError(err.message);
                document.getElementById('statusText').textContent = 'Analysis failed';
                setStep('fetch', 'error');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Analyse';
                document.getElementById('statusSpinner').style.display = '';
            }
        }

        function updateStats(data) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.style.display = 'grid';

            // Count active layers (those with features > 0)
            let activeLayers = 0;
            let highRiskCells = 0;
            let deepFloodCells = 0;

            Object.entries(data.layers).forEach(([key, layer]) => {
                if (layer.features > 0) activeLayers++;
                if (key === 'risk_band_High') highRiskCells = layer.features;
                if (key === 'depth_0.9m') deepFloodCells += layer.features;
                if (key === 'depth_1.2m') deepFloodCells += layer.features;
            });

            // Estimate area: each 2m grid cell = 4 sq m, convert to hectares
            const areaSqM = data.total_features * 4;
            const areaHa = (areaSqM / 10000).toFixed(1);

            animateValue(document.getElementById('statFeatures'), 0, data.total_features, 1000);
            animateValue(document.getElementById('statLayers'), 0, activeLayers, 600);
            document.getElementById('statArea').textContent = areaHa;
            document.getElementById('statRadius').textContent = data.radius;

            // Update info cards
            document.getElementById('infoHighRisk').textContent = highRiskCells.toLocaleString();
            document.getElementById('infoDeepFlood').textContent = deepFloodCells.toLocaleString();
            document.getElementById('infoDataLayers').textContent = activeLayers;

            // Calculate risk intensity for gauge
            // Based on ratio of high risk cells to total search area cells
            const searchAreaCells = Math.PI * Math.pow(data.radius, 2) / 4; // approximate 2m grid cells in buffer
            const riskPercent = Math.min((highRiskCells / searchAreaCells) * 100 * 5, 100); // scaled
            let riskLabel = 'Minimal';
            if (riskPercent > 66) riskLabel = 'Significant';
            else if (riskPercent > 33) riskLabel = 'Moderate';
            else if (riskPercent > 10) riskLabel = 'Low-Moderate';

            updateGauge(riskPercent, riskLabel);
        }

        function renderResults(data) {
            const panel = document.getElementById('resultsPanel');

            document.getElementById('resultPostcode').textContent = data.postcode;
            document.getElementById('resultCoords').textContent =
                `E${data.easting} N${data.northing}`;
            document.getElementById('resultDistrict').textContent =
                data.admin_district || '';

            // Risk layers
            const riskContainer = document.getElementById('riskLayers');
            riskContainer.innerHTML = '';
            const riskColors = {
                'risk_band_High': '#dc2626',
                'risk_band_Medium': '#f97316',
                'risk_band_Low': '#3b82f6',
            };
            Object.entries(data.layers).forEach(([key, layer]) => {
                if (!key.startsWith('risk_band_')) return;
                riskContainer.innerHTML += layerItemHTML(key, layer, riskColors[key] || '#666');
            });

            // Depth layers
            const depthContainer = document.getElementById('depthLayers');
            depthContainer.innerHTML = '';
            const depthColors = {
                'depth_0.2m': '#93c5fd',
                'depth_0.3m': '#60a5fa',
                'depth_0.6m': '#3b82f6',
                'depth_0.9m': '#2563eb',
                'depth_1.2m': '#1d4ed8',
            };
            Object.entries(data.layers).forEach(([key, layer]) => {
                if (!key.startsWith('depth_')) return;
                depthContainer.innerHTML += layerItemHTML(key, layer, depthColors[key] || '#666');
            });

            panel.classList.add('visible');
        }

        function layerItemHTML(key, layer, color) {
            const label = key.replace(/_/g, ' ').replace('risk band ', '').replace('depth ', '');
            const statusClass = layer.status === 'ok' ? 'ok' :
                               layer.status === 'no_data' ? 'no-data' : 'error';
            const statusText = layer.status === 'ok' ? 'OK' :
                              layer.status === 'no_data' ? 'No data' : 'Error';
            return `
                <div class="layer-item">
                    <div class="layer-swatch" style="background:${color}"></div>
                    <span class="layer-name">${label}</span>
                    <span class="layer-count">${layer.features.toLocaleString()}</span>
                    <span class="layer-status ${statusClass}">${statusText}</span>
                </div>
            `;
        }

        function loadMapPreview(data) {
            if (!data.bbox_bng) return;
            const [minx, miny, maxx, maxy] = data.bbox_bng;
            const bbox = `${minx},${miny},${maxx},${maxy}`;

            const img = document.getElementById('mapImage');
            const placeholder = document.getElementById('mapPlaceholder');
            const overlay = document.getElementById('mapOverlay');

            img.src = `/api/wms-preview?bbox=${bbox}&width=800&height=800&layer=rofsw`;
            img.style.display = 'block';
            placeholder.style.display = 'none';
            overlay.classList.add('visible');
            document.getElementById('mapOverlayBbox').textContent = `BNG: ${bbox}`;

            img.onerror = () => {
                img.style.display = 'none';
                overlay.classList.remove('visible');
                placeholder.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h3 style="font-size: 16px; margin-bottom: 8px; color: var(--text-muted);">Map preview unavailable</h3>
                        <p style="color: var(--text-muted); font-size: 13px;">
                            WMS may require zoom level &lt; 1:50,000.<br>
                            Your shapefiles are still ready to download.
                        </p>
                    </div>
                `;
                placeholder.style.display = 'block';
            };
        }

        function downloadResults() {
            if (!currentResults || !currentResults.zip_filename) return;
            window.location.href = `/api/download/${currentResults.zip_filename}`;
        }

        function addToHistory(postcode, data) {
            const item = {
                postcode: data.postcode,
                time: new Date().toLocaleTimeString(),
                features: data.total_features,
            };
            history.unshift(item);
            if (history.length > 10) history.pop();
            localStorage.setItem('flood-hapi-history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            list.innerHTML = history.map(h => `
                <div class="history-item" onclick="document.getElementById('postcodeInput').value='${h.postcode}';processPostcode();">
                    <span class="history-postcode">${h.postcode}</span>
                    <span class="history-features">${h.features.toLocaleString()} cells</span>
                    <span class="history-time">${h.time}</span>
                </div>
            `).join('');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
